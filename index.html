<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Krishi - Light Theme</title>
  <style>
    :root{
      --bg:#f8fafc;
      --card:#ffffff;
      --muted:#64748b;
      --accent:#22c1c3;
      --chat-bg:#f1f5f9;
      --chat-user:#667eea;
      --chat-bot:#764ba2;
      --text:#0f172a;
      --border:#e2e8f0;
    }
    * { box-sizing: border-box; }
    body{
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      margin:0;
      background:linear-gradient(180deg,#f8fafc 0%, #e0f2fe 100%);
      color:var(--text);
      min-height:100vh;
    }
    .container{
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    header{
      text-align:center;
      margin-bottom:24px;
    }
    h1{
      margin:0 0 8px 0;
      font-size:28px;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
    }
    .main-grid{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    .dashboard-section{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:12px;
    }
    .card{
      background:var(--card);
      padding:16px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      border:1px solid var(--border);
    }
    .card h3{
      margin:0 0 12px 0;
      font-size:16px;
      color:var(--text);
    }
    .value{
      font-size:24px;
      font-weight:700;
      color:var(--text);
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    label{
      font-size:13px;
      color:var(--muted);
      display:block;
      margin-bottom:4px;
    }
    input[type=range]{
      width:100%;
    }
    input[type=number], select{
      padding:6px 8px;
      border-radius:6px;
      border:1px solid var(--border);
      background:var(--bg);
      color:var(--text);
      width:100%;
    }
    button{
      background:var(--accent);
      border:none;
      padding:8px 16px;
      border-radius:8px;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
      font-size:13px;
    }
    button:hover{
      opacity:0.8;
      transform:translateY(-1px);
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .sensor-grid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
    .sensor-item{
      text-align:center;
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    /* Chatbot Styles */
    .chat-container{
      background:var(--card);
      border-radius:16px;
      padding:20px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      height:700px;
    }
    .chat-header{
      text-align:center;
      margin-bottom:16px;
    }
    .chat-header h2{
      margin:0;
      font-size:20px;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .city-label{
      font-size:13px;
      color:var(--muted);
      margin-top:4px;
    }
    #weather-info{
      background:rgba(102,126,234,0.08);
      border:1px solid rgba(102,126,234,0.2);
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
      font-size:13px;
      line-height:1.6;
      color:var(--text);
    }
    #getWeatherBtn{
      width:100%;
      padding:10px;
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin-bottom:12px;
      color:#fff;
    }
    #chat-box{
      flex:1;
      overflow-y:auto;
      background:var(--bg);
      border-radius:12px;
      padding:12px;
      margin-bottom:12px;
      border:1px solid var(--border);
    }
    .message{
      margin:8px 0;
      padding:10px 14px;
      border-radius:12px;
      max-width:85%;
      animation:slideIn 0.3s ease;
      word-break: break-word;
    }
    @keyframes slideIn{
      from{opacity:0;transform:translateY(10px)}
      to{opacity:1;transform:translateY(0)}
    }
    .user{
      background:linear-gradient(135deg, var(--chat-user) 0%, #764ba2 100%);
      color:white;
      margin-left:auto;
      text-align:right;
    }
    .bot{
      background:rgba(102,126,234,0.1);
      border:1px solid rgba(102,126,234,0.2);
      color:var(--text);
    }
    #controls{
      display:flex;
      gap:8px;
    }
    #user-input{
      flex:1;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:white;
      color:var(--text);
      font-size:14px;
    }
    #user-input:focus{
      outline:none;
      border-color:var(--chat-user);
    }
    #mic-btn{
      background:rgba(102,126,234,0.1);
      color:#667eea;
      padding:12px 16px;
    }
    #mic-btn.listening{
      background:#e74c3c;
      color:white;
      animation:pulse 1s infinite;
    }
    @keyframes pulse{
      0%,100%{opacity:1}
      50%{opacity:0.7}
    }
    #send-btn{
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:white;
      padding:12px 20px;
    }
    .toggle-section{
      display:flex;
      justify-content:space-between;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border);
    }
    .toggle-item{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--muted);
    }
    .toggle-item input[type="checkbox"]{
      width:40px;
      height:20px;
      cursor:pointer;
      appearance:none;
      background:#cbd5e1;
      border-radius:10px;
      position:relative;
      transition:0.3s;
    }
    .toggle-item input[type="checkbox"]:checked{
      background:var(--chat-user);
    }
    .toggle-item input[type="checkbox"]::before{
      content:"";
      position:absolute;
      width:16px;
      height:16px;
      border-radius:50%;
      top:2px;
      left:2px;
      background:white;
      transition:0.3s;
    }
    .toggle-item input[type="checkbox"]:checked::before{
      left:22px;
    }
    
    #toastContainer{
      position:fixed;
      bottom:20px;
      right:20px;
      z-index:9999;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .toast{
      background:#007bff;
      color:white;
      padding:12px 20px;
      border-radius:12px;
      font-size:14px;
      box-shadow:0 4px 10px rgba(0,0,0,0.2);
      opacity:0;
      transform:translateY(20px);
      animation:slideUp 0.4s ease forwards, fadeOut 0.4s ease 3s forwards;
    }
    @keyframes slideUp{
      to{opacity:1;transform:translateY(0)}
    }
    @keyframes fadeOut{
      to{opacity:0;transform:translateY(20px)}
    }
    
    @media (max-width:1024px){
      .main-grid{
        grid-template-columns:1fr;
      }
      .chat-container{
        height:500px;
      }
    }
    @media (max-width:768px){
      .dashboard-section{
        grid-template-columns:1fr;
      }
      .sensor-grid{
        grid-template-columns:1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåæ Smart Krishi</h1>
      <p class="subtitle">Real-time monitoring, control & AI-powered crop assistance for Indore</p>
    </header>

    <div class="main-grid">
      <!-- Dashboard Section -->
      <div>
        <div class="dashboard-section">
          <!-- Security Card -->
          <div class="card">
            <h3>üîê Security Status</h3>
            <div class="row">
              <div>
                <div id="securityStatus" class="value">‚Äî</div>
              </div>
              <div id="securityIcon" style="font-size:40px">üîí</div>
            </div>
          </div>

          <!-- Relay Card -->
          <div class="card">
            <h3>‚ö° Relay Control</h3>
            <div class="row">
              <div class="value" id="relayState">‚Äî</div>
              <button id="btnToggleRelay">Toggle</button>
            </div>
            <div style="margin-top:8px;font-size:12px;color:var(--muted)" id="relayMessage">&nbsp;</div>
          </div>

          <!-- Mode Selection -->
          <div class="card">
            <h3>‚öôÔ∏è Mode Selection</h3>
            <div style="margin-top:8px">
              <label style="display:block;margin-bottom:8px;cursor:pointer;color:var(--text)">
                <input type="radio" name="mode" id="autoMode" checked> Auto Mode
              </label>
              <label style="display:block;cursor:pointer;color:var(--text)">
                <input type="radio" name="mode" id="manualMode"> Manual Mode
              </label>
            </div>
          </div>

          <!-- Manual Control -->
          <div class="card">
            <h3>üéÆ Manual Control</h3>
            <div class="controls">
              <label style="cursor:pointer;color:var(--text)">
                <input type="checkbox" id="manualToggle"> Enable Manual
              </label>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="manualState" style="flex:1">
                  <option>OFF</option>
                  <option>ON</option>
                </select>
                <button id="applyManual">Apply</button>
              </div>
            </div>
          </div>

          <!-- Sensors -->
          <div class="card" style="grid-column:span 2">
            <h3>üìä Sensor Readings</h3>
            <div class="sensor-grid">
              <div class="sensor-item">
                <label>Temperature</label>
                <div class="value" id="temperature">‚Äî</div>
              </div>
              <div class="sensor-item">
                <label>Humidity</label>
                <div class="value" id="humidity">‚Äî</div>
              </div>
              <div class="sensor-item">
                <label>Soil Moisture</label>
                <div class="value" id="soil">‚Äî</div>
              </div>
              <div class="sensor-item">
                <label>Rain Status</label>
                <div class="value" id="rain">‚Äî</div>
              </div>
            </div>
          </div>

          <!-- Soil Threshold -->
          <div class="card">
            <h3>üíß Soil Threshold</h3>
            <div id="soilThresholdVal" style="font-size:20px;font-weight:700;margin-bottom:8px;color:var(--text)">40%</div>
            <input id="soilThreshold" type="range" min="0" max="100" value="40">
            <button id="btnSaveThreshold" style="margin-top:8px;width:100%">Save Threshold</button>
          </div>

          <!-- Timer -->
          <div class="card">
            <h3>‚è±Ô∏è Timer Control</h3>
            <div class="controls">
              <div>
                <label>Duration (seconds)</label>
                <input id="timerDuration" type="number" min="1" value="30">
              </div>
              <div style="display:flex;gap:8px">
                <button id="btnStartTimer" style="flex:1">Start</button>
                <button id="btnStopTimer" style="flex:1">Stop</button>
              </div>
              <div style="font-size:12px;color:var(--text)">
                <div>Status: <span id="timerStatus">‚Äî</span></div>
                <div>Remaining: <span id="remainingTime">‚Äî</span> sec</div>
              </div>
            </div>
          </div>

          <!-- LDR -->
          <div class="card">
            <h3>üí° LDR / Beam</h3>
            <div style="margin-top:8px;color:var(--text)">
              Beam value: <span id="beamVal" style="font-weight:600">‚Äî</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chatbot Section -->
      <div>
        <div class="chat-container">
          <div class="chat-header">
            <h2>ü§ñ AI Crop Assistant</h2>
            <div class="city-label">üìç Indore, Madhya Pradesh</div>
          </div>

          <div id="weather-info">üå§ Loading weather...</div>
          <button id="getWeatherBtn">üîÑ Refresh Weather</button>
 
          <div id="chat-box"></div>

          <div id="controls">
            <input type="text" id="user-input" placeholder="Ask about crops, irrigation..." />
            <button id="mic-btn">üéôÔ∏è</button>
            <button id="send-btn">Send</button>
            <button id="stop-voice-btn" title="Stop Voice (TTS)">üîá</button>
          </div>

          <div class="toggle-section">
            <div class="toggle-item">
              <span>üáÆüá≥ Hindi</span>
              <input type="checkbox" id="lang-toggle" />
            </div>
            <div class="toggle-item">
              <span>üîä TTS</span>
              <input type="checkbox" id="tts-toggle" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toastContainer"></div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyBFDcw1HNyZp6rRLMIEKX7c6-SdR7t7NCg",
      authDomain: "esp32-agri-3c9a0.firebaseapp.com",
      databaseURL: "https://esp32-agri-3c9a0-default-rtdb.firebaseio.com",
      projectId: "esp32-agri-3c9a0",
      storageBucket: "esp32-agri-3c9a0.appspot.com",
      messagingSenderId: "687937182162",
      appId: "1:687937182162:web:24e8514ce770c7117cd00b"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Gemini Config & Weather key
    const GEMINI_API_KEY = "AIzaSyDPWG0daDvSAsGuKWRK154hno4w8n3f35o";
    const WEATHER_API_KEY = "93ddf07dd0fc46c213a2900b17d633ab";
    const FIXED_CITY = "Indore";

    // Initialize Gemini client
    const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });

    let weatherData = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Toast functionality
    const toastContainer = document.getElementById('toastContainer');
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      toastContainer.appendChild(toast);
      setTimeout(() => toast.remove(), 3500);
    }

    // Firebase DB write helper
    function write(path, value) {
      return db.ref(path).set(value).catch(e=>{
        console.error('DB write error',e);
        showToast('‚ùå Failed to update database');
      });
    }

    // Dashboard Elements
    const el = {
      temperature: document.getElementById('temperature'),
      humidity: document.getElementById('humidity'),
      soil: document.getElementById('soil'),
      rain: document.getElementById('rain'),
      securityStatus: document.getElementById('securityStatus'),
      securityIcon: document.getElementById('securityIcon'),
      relayState: document.getElementById('relayState'),
      relayMessage: document.getElementById('relayMessage'),
      manualToggle: document.getElementById('manualToggle'),
      manualState: document.getElementById('manualState'),
      applyManual: document.getElementById('applyManual'),
      soilThreshold: document.getElementById('soilThreshold'),
      soilThresholdVal: document.getElementById('soilThresholdVal'),
      btnSaveThreshold: document.getElementById('btnSaveThreshold'),
      btnToggleRelay: document.getElementById('btnToggleRelay'),
      timerDuration: document.getElementById('timerDuration'),
      btnStartTimer: document.getElementById('btnStartTimer'),
      btnStopTimer: document.getElementById('btnStopTimer'),
      timerStatus: document.getElementById('timerStatus'),
      remainingTime: document.getElementById('remainingTime'),
      beamVal: document.getElementById('beamVal'),
      autoMode: document.getElementById('autoMode'),
      manualMode: document.getElementById('manualMode')
    };

    // Chatbot Elements
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const langToggle = document.getElementById("lang-toggle");
    const ttsToggle = document.getElementById("tts-toggle");
    const weatherInfo = document.getElementById("weather-info");
    const micBtn = document.getElementById("mic-btn");

    // Firebase Auth
    auth.signInAnonymously().catch(err => console.error('Auth error', err));

    // Firebase Listeners
    db.ref('/sensors').on('value', snap => {
      const s = snap.val() || {};
      if (s.temperature !== undefined) el.temperature.textContent = s.temperature + '¬∞C';
      if (s.humidity !== undefined) el.humidity.textContent = s.humidity + '%';
      if (s.soil !== undefined) el.soil.textContent = s.soil + '%';
      if (s.rain !== undefined) el.rain.textContent = s.rain ? 'YES' : 'NO';
    });

    db.ref('/security/status').on('value', snap => {
      const v = snap.val() || '';
      el.securityStatus.textContent = v;
      el.securityIcon.textContent = v.toLowerCase().includes('broken') ? 'üö®' : 'üîí';
    });

    db.ref('/relay').on('value', snap => {
      const r = snap.val() || {};
      if (r.state !== undefined) el.relayState.textContent = r.state;
      if (r.message) el.relayMessage.textContent = r.message;
      if (r.manual !== undefined) el.manualToggle.checked = !!r.manual;
      if (r.soilThreshold !== undefined) {
        el.soilThreshold.value = r.soilThreshold;
        el.soilThresholdVal.textContent = r.soilThreshold + '%';
      }
      if (r.timerStatus) el.timerStatus.textContent = r.timerStatus;
      if (r.remainingTime !== undefined) el.remainingTime.textContent = r.remainingTime;
    });

    db.ref('/relay/timerStatus').on('value', (snap) => {
      const status = snap.val();
      if (status === "Timer running") showToast("‚è±Ô∏è Timer started ‚Äî Pump ON");
      else if (status === "Timer complete") showToast("‚úÖ Timer complete ‚Äî Pump OFF");
    });

    // Dashboard Controls
    el.btnToggleRelay.addEventListener('click', async ()=>{
      if (el.autoMode.checked) {
        showToast('‚ö†Ô∏è Switch to Manual mode first');
        return;
      }
      const cur = (await db.ref('/relay/state').once('value')).val();
      const next = (cur === 'ON') ? 'OFF' : 'ON';
      await write('/relay/state', next);
      showToast(`‚úÖ Relay ${next}`);
    });

    el.applyManual.addEventListener('click', async ()=>{
      if (el.autoMode.checked) {
        showToast('‚ö†Ô∏è Switch to Manual mode first');
        return;
      }
      await write('/relay/manual', true);
      await write('/relay/state', el.manualState.value);
      showToast(`‚úÖ Manual: ${el.manualState.value}`);
    });

    el.manualToggle.addEventListener('change', ()=>{
      if (el.autoMode.checked) {
        showToast('‚ö†Ô∏è Auto mode active');
        el.manualToggle.checked=false;
        return;
      }
      write('/relay/manual', el.manualToggle.checked);
    });

    el.btnSaveThreshold.addEventListener('click', async ()=>{
      const v = parseInt(el.soilThreshold.value);
      await write('/relay/soilThreshold', v);
      el.soilThresholdVal.textContent = v + '%';
      showToast(`‚úÖ Threshold: ${v}%`);
    });

    function updateSoilThresholdState() {
      const isAuto = el.autoMode.checked;
      el.soilThreshold.disabled = !isAuto;
      el.btnSaveThreshold.disabled = !isAuto;
      el.soilThreshold.style.opacity = isAuto ? "1" : "0.5";
      el.btnSaveThreshold.style.opacity = isAuto ? "1" : "0.6";
    }

    auth.onAuthStateChanged(() => updateSoilThresholdState());

    el.autoMode.addEventListener('change', ()=> {
      if (el.autoMode.checked) {
        el.manualMode.checked = false;
        write('/relay/manual', false);
        updateSoilThresholdState();
        showToast('‚úÖ Auto Mode');
      }
    });

    el.manualMode.addEventListener('change', ()=> {
      if (el.manualMode.checked) {
        el.autoMode.checked = false;
        write('/relay/manual', true);
        updateSoilThresholdState();
        showToast('‚úÖ Manual Mode');
      }
    });

    el.btnStartTimer.addEventListener('click', async ()=>{
      const sec = parseInt(el.timerDuration.value,10) || 0;
      if (sec <= 0) {
        showToast('‚ö†Ô∏è Invalid duration');
        return;
      }
      await write('/relay/timerDuration', sec);
      await write('/relay/startTimer', true);
      showToast(`‚è±Ô∏è Timer: ${sec}s`);
    });

    el.btnStopTimer.addEventListener('click', async ()=>{
      await write('/relay/startTimer', false);
      await write('/relay/timerDuration', 0);
      await write('/relay/timerStatus', 'Stopped');
      showToast('‚èπÔ∏è Timer stopped');
    });

    el.soilThreshold.addEventListener('input', ()=>{
      el.soilThresholdVal.textContent = el.soilThreshold.value + '%';
    });

    // Chatbot Functions
    function addMessage(text, sender) {
      const div = document.createElement("div");
      div.classList.add("message", sender);
      div.textContent = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;

      if (sender === "bot" && ttsToggle.checked) {
        try {
          const speech = new SpeechSynthesisUtterance(text);
          speech.lang = langToggle.checked ? "hi-IN" : "en-US";
          window.speechSynthesis.cancel();
          window.speechSynthesis.speak(speech);
        } catch (e) {
          console.error("TTS error", e);
        }
      }
    }

    function getIrrigationAdvice(temp, humidity, rain) {
      if (rain > 2) return "üíß Rain expected ‚Äî no irrigation needed";
      if (humidity > 75) return "üå´Ô∏è High humidity ‚Äî light irrigation";
      if (temp > 34) return "üî• Hot ‚Äî early morning irrigation";
      return "üå§ Moderate ‚Äî normal schedule";
    }

    async function getWeather() {
      weatherInfo.textContent = "‚è≥ Fetching weather...";
      try {
        const res = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${FIXED_CITY}&appid=${WEATHER_API_KEY}&units=metric`
        );
        const data = await res.json();
        if (data.cod !== 200) throw new Error(data.message || "City not found");
        const rain = data.rain ? data.rain["1h"] || data.rain["3h"] || 0 : 0;
        weatherData = {
          city: FIXED_CITY,
          temp: data.main.temp,
          humidity: data.main.humidity,
          desc: data.weather[0].description,
          rain,
        };
        const advice = getIrrigationAdvice(weatherData.temp, weatherData.humidity, weatherData.rain);
        weatherInfo.innerHTML = `
          üåç <b>${FIXED_CITY}</b><br>
          üå° ${weatherData.temp}¬∞C | üíß ${weatherData.humidity}%<br>
          üå¶ ${weatherData.desc}<br>
          üìÖ Tomorrow: ${advice}
        `;
        addMessage(`üìç Weather: ${weatherData.temp}¬∞C, ${weatherData.desc}`, "bot");
      } catch (err) {
        console.error("Weather error", err);
        weatherInfo.textContent = "‚ö†Ô∏è " + (err.message || "Failed to fetch weather");
      }
    }

    function extractTextFromModelResult(result) {
      try {
        if (result?.response && typeof result.response.text === 'function') {
          return result.response.text();
        }
        if (result?.output?.[0]?.content?.[0]?.text) return result.output[0].content[0].text;
        if (result?.candidates?.[0]?.content) return result.candidates[0].content;
        if (typeof result === 'string') return result;
        return JSON.stringify(result);
      } catch (e) {
        console.error("extractText error", e);
        return "‚ö†Ô∏è (Could not parse model response)";
      }
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;
      addMessage(message, "user");
      userInput.value = "";

      let prompt = message;
      if (weatherData && /weather|rain|crop|temperature|climate|irrigation|soil|humidity|farm/i.test(message)) {
        prompt = `You are an expert agricultural advisor for Indore. Current weather:
Temperature: ${weatherData.temp}¬∞C
Humidity: ${weatherData.humidity}%
Weather: ${weatherData.desc}
Rain: ${weatherData.rain} mm

Question: ${message}

Provide practical advice on:
1. Suitable crops for current conditions
2. Irrigation best practices
3. Pest management
4. Seasonal recommendations

Keep it clear and actionable.`;
      } else {
        prompt = `You are an agricultural expert. Question: ${message}

Provide helpful advice on crop management, irrigation, pest control, and farming practices.`;
      }

      const language = langToggle.checked ? "Hindi" : "English";
      const finalPrompt = `Reply in ${language}. ${prompt}`;

      try {
        const result = await model.generateContent(finalPrompt);
        const text = extractTextFromModelResult(result);
        addMessage(text, "bot");
        retryCount = 0;
      } catch (err) {
        console.error("API Error:", err);
        const errMsg = (err && err.message) ? err.message : String(err);

        if (/429|rate limit|Too Many Requests/i.test(errMsg) && retryCount < MAX_RETRIES) {
          retryCount++;
          const waitTime = Math.pow(2, retryCount) * 1000;
          addMessage(`‚è≥ Rate limit. Retrying in ${waitTime/1000}s... (${retryCount}/${MAX_RETRIES})`, "bot");
          setTimeout(() => {
            userInput.value = message;
            sendMessage();
          }, waitTime);
        } else if (/429|rate limit|Too Many Requests/i.test(errMsg)) {
          addMessage("‚ö†Ô∏è Rate limit exceeded. Try again in a few minutes.", "bot");
          retryCount = 0;
        } else {
          addMessage("‚ö†Ô∏è Error: " + errMsg, "bot");
        }
      }
    }

    // Speech Recognition
    let recognition;
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (SpeechRec) {
      recognition = new SpeechRec();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = "en-IN";

      recognition.onstart = () => {
        micBtn.classList.add("listening");
        micBtn.textContent = "üé§";
      };
      recognition.onend = () => {
        micBtn.classList.remove("listening");
        micBtn.textContent = "üéôÔ∏è";
      };
      recognition.onerror = (e) => {
        console.error("Speech recognition error", e);
        addMessage("üéôÔ∏è Voice input error. Try again.", "bot");
      };
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        sendMessage();
      };

      micBtn.addEventListener('click', () => {
        try {
          recognition.lang = langToggle.checked ? "hi-IN" : "en-IN";
          recognition.start();
        } catch (e) {
          console.error("mic start error", e);
        }
      });
    } else {
      micBtn.disabled = true;
      micBtn.title = "Speech recognition not supported in this browser";
    }

    // Voice Stop Function
    function stopVoice() {
      try {
        window.speechSynthesis.cancel();
        showToast("üîá Voice stopped");
      } catch (e) {
        console.error("stopVoice error", e);
      }
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") stopVoice();
    });

    document.addEventListener("DOMContentLoaded", () => {
      const stopBtn = document.getElementById("stop-voice-btn");
      if (stopBtn) stopBtn.onclick = stopVoice;
    });

    // Event Listeners
    document.getElementById("send-btn").onclick = sendMessage;
    document.getElementById("getWeatherBtn").onclick = getWeather;
    userInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Initial welcome message
    addMessage("üëã Hi! I'm your AI Crop Assistant. Ask about crops, irrigation, pests, or weather ‚Äî I'll help with practical, actionable advice.", "bot");

    // Initial Load
    getWeather();

    // Gemini Crop Prediction
    let language = "en";

    const cropCard = document.createElement("div");
    cropCard.innerHTML = `
      <div id="crop-section" style="margin-top:20px;padding:20px;border-radius:20px;
           background:linear-gradient(135deg,#f8fafc,#e0f2fe);color:var(--text);box-shadow:0 0 10px rgba(102,126,234,0.2);border:1px solid var(--border);">
        <h2 style="font-size:22px;display:flex;align-items:center;gap:10px;">
          üåæ <span id="crop-title">AI Crop Prediction</span>
        </h2>
        <p id="crop-desc" style="color:var(--muted);margin-bottom:10px;">
          Get AI-based suggestions for the best crop based on your farm's live data.
        </p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button id="predictBtn" 
            style="background:linear-gradient(135deg,#22c1c3,#667eea);
                   color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">
            üå± Predict Best Crop
          </button>
          <button id="langToggle" 
            style="background:#cbd5e1;color:var(--text);padding:10px 20px;border:none;
                   border-radius:8px;cursor:pointer;">
            üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä
          </button>
        </div>
        <div id="prediction-box" 
             style="margin-top:15px;padding:15px;border-radius:10px;background:rgba(102,126,234,0.05);display:none;border:1px solid var(--border);">
          <h3 id="crop-name" style="color:#22c1c3;font-size:18px;margin-bottom:5px;"></h3>
          <p id="crop-reason" style="font-size:14px;color:var(--text);"></p>
        </div>
      </div>
    `;
    document.querySelector(".chat-container").appendChild(cropCard);

    document.getElementById("langToggle").addEventListener("click", () => {
      language = language === "en" ? "hi" : "en";
      const isHindi = language === "hi";
      document.getElementById("langToggle").textContent = isHindi ? "üåç English" : "üáÆüá≥ ‡§π‡§ø‡§Ç‡§¶‡•Ä";
      document.getElementById("crop-title").textContent = isHindi ? "‡§è‡§Ü‡§à ‡§´‡§∏‡§≤ ‡§≠‡§µ‡§ø‡§∑‡•ç‡§Ø‡§µ‡§æ‡§£‡•Ä" : "AI Crop Prediction";
      document.getElementById("crop-desc").textContent = isHindi
        ? "‡§Ö‡§™‡§®‡•á ‡§ñ‡•á‡§§ ‡§ï‡•á ‡§≤‡§æ‡§á‡§µ ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§∏‡§∞‡•ç‡§µ‡§∂‡•ç‡§∞‡•á‡§∑‡•ç‡§† ‡§´‡§∏‡§≤ ‡§ï‡•Ä ‡§è‡§Ü‡§à ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂ ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç‡•§"
        : "Get AI-based suggestions for the best crop based on your farm's live data.";
    });

    document.getElementById("predictBtn").addEventListener("click", async () => {
      const btn = document.getElementById("predictBtn");
      btn.disabled = true;
      btn.textContent = "üîç Analyzing...";

      try {
        const snapshot = await db.ref("/sensors").once("value");
        const s = snapshot.val();
        if (!s) {
          addMessage("‚ö†Ô∏è No sensor data found in Firebase.", "bot");
          btn.disabled = false;
          btn.textContent = "üå± Predict Best Crop";
          return;
        }

        const { temperature, humidity, soil } = s;

        const prompt = language === "hi"
          ? `‡§Ü‡§™ ‡§è‡§ï ‡§ï‡•É‡§∑‡§ø ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§π‡•à‡§Ç‡•§ ‡§®‡§ø‡§Æ‡•ç‡§® ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§∏‡§¨‡§∏‡•á ‡§â‡§™‡§Ø‡•Å‡§ï‡•ç‡§§ ‡§´‡§∏‡§≤ ‡§∏‡•Å‡§ù‡§æ‡§è‡§Ç ‡§î‡§∞ ‡§â‡§∏‡§ï‡§æ ‡§ï‡§æ‡§∞‡§£ ‡§¨‡§§‡§æ‡§è‡§Ç‡•§
‡§§‡§æ‡§™‡§Æ‡§æ‡§®: ${temperature}¬∞C
‡§®‡§Æ‡•Ä: ${humidity}%
‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡•Ä ‡§®‡§Æ‡•Ä: ${soil}%
‡§â‡§§‡•ç‡§§‡§∞ ‡§á‡§∏ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§Ç:
üåæ ‡§Ö‡§®‡•Å‡§∂‡§Ç‡§∏‡§ø‡§§ ‡§´‡§∏‡§≤: <‡§®‡§æ‡§Æ>
üß† ‡§ï‡§æ‡§∞‡§£: <‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§ï‡§æ‡§∞‡§£>`
          : `You are an agriculture expert. Based on this sensor data, recommend the best crop to grow and give a short reason.
Temperature: ${temperature}¬∞C
Humidity: ${humidity}%
Soil Moisture: ${soil}%
Format:
üåæ Recommended Crop: <name>
üß† Reason: <short reason>`;

        const result = await model.generateContent(prompt);
        const response = extractTextFromModelResult(result);

        const [_, cropName, reason] = response.match(/üåæ.*?: (.+)\nüß†.*?: (.+)/s) || [];
        document.getElementById("prediction-box").style.display = "block";
        document.getElementById("crop-name").textContent = cropName ? `üåæ ${cropName}` : "No crop identified";
        document.getElementById("crop-reason").textContent = reason || response;

        addMessage(response, "bot");
      } catch (err) {
        console.error(err);
        addMessage("‚ö†Ô∏è Error during crop prediction.", "bot");
      }

      btn.disabled = false;
      btn.textContent = "üå± Predict Best Crop";
    });
  </script>
</body>
</html>